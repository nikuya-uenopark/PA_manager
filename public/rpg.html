<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
    />
    <title>ミニRPG</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body.rpg-body {
        background: #0b132b;
        color: #fff;
        font-family: "Inter", sans-serif;
        overflow: hidden;
      }
      .rpg-topbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 46px;
        background: #1c2541;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0 10px;
        font-size: 13px;
        z-index: 10;
      }
      .rpg-topbar select {
        background: #3a506b;
        color: #fff;
        border: 1px solid #4f6480;
        border-radius: 6px;
        padding: 4px 6px;
      }
      .rpg-wrapper {
        position: fixed;
        inset: 46px 0 0 0;
        display: flex;
      }
      .rpg-left {
        flex: 0 0 70vw;
        max-width: 820px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .rpg-canvas-wrap {
        position: relative;
        image-rendering: pixelated;
      }
      #rpgCanvas {
        background: #14213d;
        box-shadow: 0 0 0 4px #222, 0 0 18px #000;
        border-radius: 4px;
        image-rendering: pixelated;
      }
      .rpg-right {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px 10px;
        overflow: auto;
        background: linear-gradient(180deg, #1c2541, #0b132b);
      }
      .rpg-panel {
        background: #243b55;
        border: 1px solid #2f4e6d;
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 12px;
        line-height: 1.4;
      }
      .rpg-panel h3 {
        margin: 0 0 4px;
        font-size: 13px;
        letter-spacing: 0.5px;
      }
      #rpgLog {
        max-height: 220px;
        overflow: auto;
        font-family: ui-monospace, monospace;
        background: #0d1b2a;
        border: 1px solid #223246;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 11px;
      }
      .rpg-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .rpg-actions button {
        flex: 1 1 calc(50% - 4px);
        background: #3a506b;
        color: #fff;
        border: 1px solid #4f6480;
        border-radius: 6px;
        padding: 6px 4px;
        font-size: 11px;
        cursor: pointer;
        letter-spacing: 0.5px;
      }
      .rpg-actions button:active {
        transform: translateY(2px);
      }
      .badge {
        display: inline-block;
        background: #ffb703;
        color: #222;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 9999px;
        font-size: 10px;
        margin-left: 4px;
      }
      .encounter-flash {
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at center,
          rgba(255, 255, 255, 0.9),
          rgba(255, 255, 255, 0)
        );
        pointer-events: none;
        animation: flash 0.6s ease forwards;
      }
      @keyframes flash {
        0% {
          opacity: 0;
        }
        30% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
      .hp-bar {
        height: 6px;
        background: #112031;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 4px;
      }
      .hp-bar span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, #06d6a0, #118ab2);
      }
      .enemy-window {
        position: absolute;
        top: -56px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #fff;
        font-family: ui-monospace, monospace;
      }
      .fade-msg {
        position: absolute;
        bottom: 6px;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 11px;
        color: #fff;
        animation: fadeMsg 2.2s ease forwards;
        pointer-events: none;
        text-shadow: 0 0 4px #000;
      }
      @keyframes fadeMsg {
        0% {
          opacity: 0;
          transform: translateY(8px);
        }
        15% {
          opacity: 1;
          transform: translateY(0);
        }
        85% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
      @keyframes bossFlash {
        0% {
          opacity: 1;
        }
        70% {
          opacity: 0;
        }
        100% {
          opacity: 0;
          display: none;
        }
      }
      @keyframes pulse {
        0% {
          transform: translateX(50%) scale(0.9);
          opacity: 0.6;
        }
        50% {
          transform: translateX(50%) scale(1.15);
          opacity: 1;
        }
        100% {
          transform: translateX(50%) scale(0.9);
          opacity: 0.6;
        }
      }
    </style>
  </head>
  <body class="rpg-body">
    <div
      class="rpg-topbar"
      id="topBar"
      style="
        height: auto;
        padding: 4px 8px;
        gap: 12px;
        align-items: flex-start;
        flex-direction: column;
        background: transparent;
        pointer-events: none;
      "
    >
      <div
        style="
          display: flex;
          align-items: center;
          gap: 8px;
          pointer-events: auto;
        "
      >
        <button
          class="rpg-btn"
          onclick="location.href='/'"
          style="background: #1c2541; border: 1px solid #2f4564"
        >
          戻る
        </button>
        <div
          id="hudLevel"
          style="font-size: 12px; font-weight: 600; letter-spacing: 0.5px"
        >
          Lv -
        </div>
      </div>
      <div
        id="hudBars"
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          width: 220px;
          background: rgba(0, 0, 0, 0.35);
          padding: 6px 8px;
          border: 1px solid #223246;
          border-radius: 8px;
          backdrop-filter: blur(4px);
          pointer-events: auto;
        "
      >
        <div
          style="
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <span>HP</span><span id="hudHpText">-</span>
        </div>
        <div class="bar hp"><span id="hudHpBar"></span></div>
        <div
          style="
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2px;
          "
        >
          <span>EXP</span><span id="hudExpText">-</span>
        </div>
        <div class="bar exp"><span id="hudExpBar"></span></div>
        <div style="font-size: 11px; margin-top: 2px">
          GOLD: <span id="hudGold">0</span>
        </div>
      </div>
    </div>
    <div class="rpg-wrapper" style="inset: 0 0 0 0; display: flex">
      <div class="rpg-canvas-wrap" id="canvasWrap" style="margin: auto">
        <canvas id="rpgCanvas" width="640" height="360"></canvas>
        <div class="fade-msg" id="fadeMsg" style="display: none"></div>
      </div>
      <div
        class="vc-left"
        id="vcLeft"
        style="position: fixed; left: 16px; bottom: 32px; z-index: 30"
      >
        <div
          class="dpad"
          style="position: relative; width: 140px; height: 140px"
        >
          <button
            data-dir="up"
            class="dpad-btn"
            style="top: 0; left: 50%; transform: translate(-50%, 0)"
          ></button>
          <button
            data-dir="left"
            class="dpad-btn"
            style="left: 0; top: 50%; transform: translate(0, -50%)"
          ></button>
          <button
            data-dir="right"
            class="dpad-btn"
            style="right: 0; top: 50%; transform: translate(0, -50%)"
          ></button>
          <button
            data-dir="down"
            class="dpad-btn"
            style="bottom: 0; left: 50%; transform: translate(-50%, 0)"
          ></button>
        </div>
      </div>
      <div
        class="vc-right"
        id="vcRight"
        style="
          position: fixed;
          right: 24px;
          bottom: 40px;
          z-index: 30;
          display: flex;
          gap: 0;
        "
      >
        <div class="buttons" style="display:flex;flex-direction:column;align-items:center;gap:22px;">
          <button data-btn="settings" class="btn-round btn-settings">設定</button>
          <button data-btn="dash" class="btn-round btn-dash">走</button>
          <button data-btn="inspect" class="btn-round btn-inspect">調</button>
        </div>
      </div>
      <!-- Modal Overlay -->
      <div
        id="modalOverlay"
        style="
          display: none;
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.6);
          backdrop-filter: blur(2px);
          z-index: 50;
          align-items: center;
          justify-content: center;
        "
      >
        <div
          id="modalWindow"
          style="
            background: #16263a;
            border: 1px solid #2a3f57;
            border-radius: 12px;
            min-width: 320px;
            max-width: 420px;
            padding: 14px 16px;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            gap: 12px;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <h3
              id="modalTitle"
              style="margin: 0; font-size: 15px; letter-spacing: 1px"
            >
              設定
            </h3>
            <button
              id="modalCloseBtn"
              style="
                background: #243b55;
                color: #fff;
                border: 1px solid #2f4e6d;
                border-radius: 6px;
                padding: 4px 8px;
                font-size: 11px;
              "
            >
              ×
            </button>
          </div>
          <div
            id="modalBody"
            style="max-height: 360px; overflow: auto; line-height: 1.5"
          ></div>
          <div id="modalHint" style="font-size: 10px; color: #94a3b8">
            D-Pad上下で選択 / 調べる=決定 / 設定=閉じる
          </div>
        </div>
      </div>
    </div>
    <script>
      // ===== 基本設定 =====
      const API = "/api/games/rpg";
      const params = new URLSearchParams(location.search);
      const currentPlayerId =
        Number(params.get("staffId")) ||
        Number(localStorage.getItem("gameSelectedStaffId")) ||
        null;
      if (!currentPlayerId) {
        alert("スタッフ未選択: ゲームハブから入ってください");
      }
      let state = null;
      let walking = false;
      let encounterStep = 0; // 自動エンカのみ
      const canvas = document.getElementById("rpgCanvas");
      const ctx = canvas.getContext("2d");
      // ===== フィールドスケール設定 =====
      const TILE_BASE = 16; // 元タイルサイズ
      let TILE = TILE_BASE; // 拡大後サイズ
      const mapW = 40,
        mapH = 22; // 論理グリッド
      function resizeCanvasScale() {
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        let scaleTile = Math.floor(vw / mapW);
        if (scaleTile < 4) scaleTile = 4;
        if (scaleTile * mapH > vh) {
          scaleTile = Math.floor(vh / mapH);
        }
        TILE = scaleTile;
        canvas.width = mapW * TILE;
        canvas.height = mapH * TILE;
        canvas.style.width = canvas.width + "px";
        canvas.style.height = canvas.height + "px";
        draw();
      }
      window.addEventListener("resize", resizeCanvasScale);
      // 0 floor,1 wall,2 inn,3 shop,4 chestClosed,5 chestOpen
      const world = Array.from({ length: mapH }, (_, y) =>
        Array.from({ length: mapW }, (_, x) =>
          x === 0 || y === 0 || x === mapW - 1 || y === mapH - 1 ? 1 : 0
        )
      );
      const innPos = { x: 6, y: 6 };
      const shopPos = { x: 10, y: 6 };
      world[innPos.y][innPos.x] = 2;
      world[shopPos.y][shopPos.x] = 3;
      const chestSeeds = [
        { x: 14, y: 5 },
        { x: 20, y: 10 },
        { x: 30, y: 8 },
      ];
      chestSeeds.forEach((c) => {
        if (world[c.y][c.x] === 0) world[c.y][c.x] = 4;
      });
      // ラスボス位置 (画面右下付近)
      const bossPos = { x: mapW - 3, y: mapH - 3 }; // 端から2マス内側
      world[bossPos.y][bossPos.x] = 6; // boss tile code
      // タイル & プレイヤースプライト (配置はユーザーが public/assets/rpg/ に配置)
      // ===== アセット読み込み =====
      const tilesImg = new Image();
      tilesImg.src = "/assets/rpg/0x72_DungeonTilesetII_v1.7.png"; // 16x16 tiles
      // プレイヤー: dwarf_m (idle/run 4枚)
      const playerIdleFrames = [0, 1, 2, 3].map(
        (i) => `/assets/rpg/dwarf_m_idle_anim_f${i}.png`
      );
      const playerRunFrames = [0, 1, 2, 3].map(
        (i) => `/assets/rpg/dwarf_m_run_anim_f${i}.png`
      );
      const playerImgsIdle = [];
      const playerImgsRun = [];
      playerIdleFrames.forEach((src) => {
        const im = new Image();
        im.src = src;
        playerImgsIdle.push(im);
      });
      playerRunFrames.forEach((src) => {
        const im = new Image();
        im.src = src;
        playerImgsRun.push(im);
      });
      // 敵スプライト候補 (レベル帯で切替) 追加5種
      const enemySets = [
        { min: 1, max: 5, key: "chort", label: "インプ" },
        { min: 6, max: 15, key: "big_zombie", label: "ゾンビ" },
        { min: 16, max: 30, key: "doc", label: "狂賢者" },
        { min: 31, max: 60, key: "big_demon", label: "デーモン" },
        { min: 61, max: 999999, key: "angel", label: "堕天使" },
      ];
      function enemyIdleFrames(key) {
        return [0, 1, 2, 3].map(
          (i) => `/assets/rpg/${key}_idle_anim_f${i}.png`
        );
      }
      function enemyRunFrames(key) {
        return [0, 1, 2, 3].map((i) => `/assets/rpg/${key}_run_anim_f${i}.png`);
      }
      function selectEnemySet(level) {
        return (
          enemySets.find((s) => level >= s.min && level <= s.max) ||
          enemySets[0]
        );
      }
      // タイルマップ: (x,y) は元シート16x16グリッド座標
      const tileMap = {
        0: [0, 0], // floor
        1: [1, 0], // wall basic
        2: [4, 5], // inn (custom decorative tile)
        3: [5, 5], // shop
        4: [0, 8], // chest closed
        5: [1, 8], // chest open
        6: [7, 6], // boss tile (altar-ish)
      };
      let player = {
        x: 2,
        y: 2,
        dir: 0,
        frame: 0,
        animTime: 0,
        running: false,
      };
      // ===== ユーティリティ =====
      function log(msg) {
        /* ログUI削除済み -> no-op (必要なら console) */
      }
      function fadeMessage(msg) {
        const el = document.getElementById("fadeMsg");
        el.textContent = msg;
        el.style.display = "block";
        el.classList.remove("run");
        void el.offsetWidth;
        el.classList.add("run");
        setTimeout(() => (el.style.display = "none"), 2200);
      }
      function flashEncounter() {
        const f = document.createElement("div");
        f.className = "encounter-flash";
        canvas.parentElement.appendChild(f);
        setTimeout(() => f.remove(), 600);
      }
      function updateHUD() {
        if (!state) return;
        const { level, hp, maxHp, exp, nextExp, gold } = state;
        const hpPct = (hp / maxHp) * 100;
        const expPct = (exp / nextExp) * 100;
        document.getElementById("hudLevel").textContent = `Lv${level}`;
        document.getElementById("hudHpText").textContent = `${hp}/${maxHp}`;
        document.getElementById("hudHpBar").style.width =
          hpPct.toFixed(1) + "%";
        document.getElementById("hudExpText").textContent = `${exp}/${nextExp}`;
        document.getElementById("hudExpBar").style.width =
          expPct.toFixed(1) + "%";
        document.getElementById("hudGold").textContent = gold;
      }
      function updateStats() {
        updateHUD();
        if (currentModal) refreshModal();
      }
      async function api(action, payload) {
        if (!currentPlayerId) return;
        const body = { staffId: currentPlayerId, action, payload };
        const res = await fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          log("通信失敗:" + action);
          return null;
        }
        return await res.json();
      }
      async function initPlayer() {
        if (!currentPlayerId) return;
        const r = await api("init");
        if (r && r.state) {
          state = r.state;
          updateStats();
          draw();
          fadeMessage("ロード完了");
        }
      }
      async function doAction(k, payload) {
        if (!state) return;
        let r = null;
        if (k === "battle") {
          r = await api("battle");
          if (r?.state) {
            state = r.state;
            updateStats();
            log("戦闘:" + (r.result?.victory ? "勝利" : "敗北"));
          }
        } else if (k === "heal") {
          r = await api("heal");
          if (r?.state) {
            state = r.state;
            updateStats();
            log(r.result?.msg || "回復");
          }
        } else if (k === "equip-sword") {
          r = await api("equip", { type: "sword" });
          if (r?.state) {
            state = r.state;
            updateStats();
            log(r.result?.msg);
          }
        } else if (k === "equip-dagger") {
          r = await api("equip", { type: "dagger" });
          if (r?.state) {
            state = r.state;
            updateStats();
            log(r.result?.msg);
          }
        } else if (k === "equip-staff") {
          r = await api("equip", { type: "staff" });
          if (r?.state) {
            state = r.state;
            updateStats();
            log(r.result?.msg);
          }
        } else if (k === "equip-axe") {
          r = await api("equip", { type: "axe" });
          if (r?.state) {
            state = r.state;
            updateStats();
            log(r.result?.msg);
          }
        } else if (k === "equip-armor") {
          r = await api("equip", { type: "armor" });
          if (r?.state) {
            state = r.state;
            updateStats();
            log(r.result?.msg);
          }
        } else if (k === "boss") {
          r = await api("boss");
          if (r?.state) {
            state = r.state;
            updateStats();
            log(
              "ボス戦:" +
                (r.result?.victory
                  ? "勝利!"
                  : r.result?.log?.slice(-1)[0] || "")
            );
          }
        } else if (k === "pickup") {
          r = await api("pickup", payload);
          if (r?.state) {
            state = r.state;
            updateStats();
            log(r.result?.msg || "取得");
          }
        }
        if (r?.state) draw();
      }
      function attemptEncounter() {
        if (Math.random() < 0.18) {
          walking = false;
          flashEncounter();
          fadeMessage("エンカウント!");
          startBattle();
        }
      }
      // ===== 描画 =====
      const bossIdleFrames = [0, 1, 2, 3].map(
        (i) => `/assets/rpg/big_demon_idle_anim_f${i}.png`
      );
      const bossImgsIdle = [];
      bossIdleFrames.forEach((src) => {
        const im = new Image();
        im.src = src;
        bossImgsIdle.push(im);
      });
      let bossAnimTime = 0;
      function drawBossField() {
        const frames = bossImgsIdle;
        if (state?.bossDefeated) return; // 撃破後は非表示
        if (!frames.length || !frames[0].complete) {
          ctx.fillStyle = "#e63946";
          ctx.fillRect(
            bossPos.x * TILE + 2,
            bossPos.y * TILE + 2,
            TILE - 4,
            TILE - 4
          );
          return;
        }
        const idx = Math.floor(bossAnimTime / 300) % frames.length;
        const img = frames[idx];
        ctx.drawImage(
          img,
          bossPos.x * TILE - TILE * 0.25,
          bossPos.y * TILE - TILE * 0.5,
          TILE * 1.5,
          TILE * 1.5
        );
      }
      function draw() {
        ctx.imageSmoothingEnabled = false;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let y = 0; y < mapH; y++) {
          for (let x = 0; x < mapW; x++) {
            let t = world[y][x];
            if (t === 4 || t === 5) {
              const chest = (state?.items || []).find(
                (it) => it.type === "chest" && it.x === x && it.y === y
              );
              if (chest) t = chest.opened ? 5 : 4;
            }
            drawTile(t, x, y);
          }
        }
        drawBossField();
        if (state) drawPlayer();
        updateProximityUI();
      }
      function drawTile(t, x, y) {
        const uv = tileMap[t] || tileMap[0];
        if (!tilesImg.complete) {
          ctx.fillStyle = "#222";
          ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
          return;
        }
        ctx.drawImage(
          tilesImg,
          uv[0] * TILE_BASE,
          uv[1] * TILE_BASE,
          TILE_BASE,
          TILE_BASE,
          x * TILE,
          y * TILE,
          TILE,
          TILE
        );
      }
      function drawPlayer() {
        const frames = player.running ? playerImgsRun : playerImgsIdle;
        if (!frames.length || !frames[0].complete) {
          ctx.fillStyle = "#ffb703";
          ctx.fillRect(
            player.x * TILE + 2,
            player.y * TILE + 2,
            TILE - 4,
            TILE - 4
          );
          return;
        }
        const idx = Math.floor(player.animTime / 250) % frames.length; // 250ms per frame
        const img = frames[idx];
        ctx.drawImage(img, player.x * TILE, player.y * TILE, TILE, TILE);
      }
      // 近接インジケータ
      let proxEl = document.getElementById("proxUI");
      if (!proxEl) {
        proxEl = document.createElement("div");
        proxEl.id = "proxUI";
        proxEl.style.position = "absolute";
        proxEl.style.left = "8px";
        proxEl.style.top = "8px";
        proxEl.style.zIndex = "5";
        proxEl.style.display = "flex";
        proxEl.style.gap = "4px";
        canvas.parentElement.appendChild(proxEl);
      }
      function updateProximityUI() {
        if (!state) {
          proxEl.innerHTML = "";
          return;
        }
        const nearInn =
          Math.abs(player.x - innPos.x) <= 1 &&
          Math.abs(player.y - innPos.y) <= 1;
        const nearShop =
          Math.abs(player.x - shopPos.x) <= 1 &&
          Math.abs(player.y - shopPos.y) <= 1;
        const nearBoss =
          !state.bossDefeated &&
          Math.abs(player.x - bossPos.x) <= 1 &&
          Math.abs(player.y - bossPos.y) <= 1;
        proxEl.innerHTML = [
          nearInn
            ? '<span class="badge" style="background:#2a9d8f">宿屋</span>'
            : "",
          nearShop
            ? '<span class="badge" style="background:#a44f9d">店</span>'
            : "",
          nearBoss && !state.bossDefeated
            ? '<span class="badge" style="background:#e63946">ボス</span>'
            : "",
        ]
          .filter(Boolean)
          .join("");
      }
      // ===== 移動/操作 =====
      function movePlayerDir(dir) {
        let dx = 0,
          dy = 0;
        if (dir === "up") {
          dy = -1;
          player.dir = 3;
        } else if (dir === "down") {
          dy = 1;
          player.dir = 0;
        } else if (dir === "left") {
          dx = -1;
          player.dir = 1;
        } else if (dir === "right") {
          dx = 1;
          player.dir = 2;
        }
        const nx = player.x + dx,
          ny = player.y + dy;
        if (nx < 1 || ny < 1 || nx >= mapW - 1 || ny >= mapH - 1) return;
        if (world[ny][nx] === 1) return;
        player.x = nx;
        player.y = ny;
        player.frame = (player.frame + 1) % 60;
        player.running = true;
        player.lastMoveTs = performance.now();
        walking = true;
        encounterStep = (encounterStep + 1) % 4;
        if (encounterStep === 0) attemptEncounter();
        draw();
      }
      // アニメーションタイマー
      function animLoop(ts) {
        if (!player.lastMoveTs) player.lastMoveTs = ts;
        player.animTime = ts;
        if (ts - player.lastMoveTs > 400) player.running = false;
        draw();
        requestAnimationFrame(animLoop);
      }
      requestAnimationFrame(animLoop);
      // ボススプライト用アニメ時間も更新
      (function bossLoop(t0) {
        bossAnimTime = performance.now();
        requestAnimationFrame(bossLoop);
      })();
      // ===== 戦闘モーダル =====
      async function startBattle() {
        const r = await api("battle");
        if (!r?.state || !r.result) return;
        state = r.state;
        const { enemy, events, victory, reward } = r.result;
        openModal("battle");
        renderBattleIntro(enemy);
        await playBattleSequence(enemy, events, enemy);
        renderBattleResult(victory, reward, enemy);
        updateStats();
        draw();
      }
      async function startBossBattle() {
        const r = await api("boss");
        if (!r?.state || !r.result) return;
        state = r.state;
        const { enemy, events, victory, reward } = r.result;
        openModal("battle");
        renderBossIntro(enemy);
        await playBattleSequence(enemy, events, enemy);
        renderBossResult(victory, reward, enemy);
        updateStats();
        draw();
      }
      function renderBattleIntro(enemy) {
        const enemySet = selectEnemySet(enemy.level);
        const eIdle = enemyIdleFrames(enemySet.key).map((src) => {
          const im = new Image();
          im.src = src;
          return im;
        });
        modalTitle.textContent = "バトル";
        modalBody.innerHTML = `<div id='battleArea' style='display:flex;flex-direction:column;gap:10px;'>
          <div style='display:flex;justify-content:space-between;font-size:12px;'>
            <div>${enemy.name || enemySet.label || "敵"} Lv${enemy.level}</div>
            <div>HP <span id='enemyHpText'>${enemy.hp}/${
          enemy.maxHp
        }</span></div>
          </div>
          <div class='bar hp'><span id='enemyHpBar' style='width:100%'></span></div>
          <div style='height:140px;position:relative;border:1px solid #2f4e6d;border-radius:8px;background:#0f1c2b;overflow:hidden;'>
            <div id='battleLog' style='position:absolute;left:6px;top:6px;bottom:6px;width:44%;display:flex;flex-direction:column;gap:4px;font-size:11px;overflow:auto;padding-right:4px;'></div>
            <div id='battleSprites' style='position:absolute;right:0;top:0;bottom:0;width:56%;display:flex;align-items:center;justify-content:space-around;'>
              <div style='display:flex;flex-direction:column;align-items:center;gap:4px;'>
                <img id='playerSprite' style='image-rendering:pixelated;width:64px;height:64px;' src='${
                  playerIdleFrames[0]
                }' />
                <div style='font-size:10px;'>あなた</div>
              </div>
              <div style='display:flex;flex-direction:column;align-items:center;gap:4px;'>
                <img id='enemySprite' style='image-rendering:pixelated;width:64px;height:64px;' src='${
                  eIdle[0].src
                }' />
                <div style='font-size:10px;'>${
                  enemy.name || enemySet.label || "敵"
                }</div>
              </div>
            </div>
          </div>
          <div id='battleResult' style='font-size:12px;min-height:24px;'></div>
          <div style='font-size:10px;color:#94a3b8;'>演出中は操作できません</div>
        </div>`;
        // 簡易アニメループ
        let f = 0;
        const ps = document.getElementById("playerSprite");
        const es = document.getElementById("enemySprite");
        const loop = () => {
          if (currentModal !== "battle") return;
          f = (f + 1) % 4;
          if (ps) ps.src = playerImgsIdle[f % playerImgsIdle.length].src;
          if (es && eIdle[f]) es.src = eIdle[f].src;
          setTimeout(loop, 260);
        };
        loop();
      }
      function renderBossIntro(enemy) {
        modalTitle.textContent = "ラスボス";
        // 特殊演出 (フラッシュ + 赤枠)
        modalBody.innerHTML = `<div id='battleArea' style='display:flex;flex-direction:column;gap:10px;'>
          <div style='display:flex;justify-content:space-between;font-size:12px;color:#f94144;font-weight:600;'>
            <div>Lv${enemy.level} 魔王</div><div>HP <span id='enemyHpText'>${enemy.hp}/${enemy.hp}</span></div>
          </div>
          <div class='bar hp'><span id='enemyHpBar' style='width:100%;background:linear-gradient(90deg,#e63946,#9d0208)'></span></div>
          <div style='height:140px;position:relative;border:2px solid #e63946;border-radius:8px;background:#1a0f1c;overflow:hidden;'>
            <div id='battleLog' style='position:absolute;left:6px;top:6px;bottom:6px;width:46%;display:flex;flex-direction:column;gap:4px;font-size:11px;overflow:auto;padding-right:4px;'></div>
            <div id='battleSprites' style='position:absolute;right:0;top:0;bottom:0;width:54%;display:flex;align-items:center;justify-content:space-around;'>
              <div style='display:flex;flex-direction:column;align-items:center;gap:4px;'>
                <img id='playerSprite' style='image-rendering:pixelated;width:72px;height:72px;filter:drop-shadow(0 0 6px #00b4d8);' src='${playerIdleFrames[0]}' />
                <div style='font-size:10px;'>あなた</div>
              </div>
              <div style='display:flex;flex-direction:column;align-items:center;gap:4px;'>
                <div id='bossAura' style='position:absolute;right:50%;transform:translateX(50%);width:120px;height:120px;border-radius:50%;background:radial-gradient(circle,#e6394644,#0000);filter:blur(8px);animation:pulse 2s infinite;'></div>
                <img id='enemySprite' style='image-rendering:pixelated;width:96px;height:96px;filter:drop-shadow(0 0 8px #e63946);' src='/assets/rpg/big_demon_idle_anim_f0.png' />
                <div style='font-size:10px;color:#f94144;'>ラスボス</div>
              </div>
            </div>
          </div>
          <div id='battleResult' style='font-size:12px;min-height:24px;'></div>
          <div style='font-size:10px;color:#fca311;'>最終決戦!</div>
        </div>`;
        // アニメ
        let f = 0;
        const ps = document.getElementById("playerSprite");
        const es = document.getElementById("enemySprite");
        const demonIdle = enemyIdleFrames("big_demon").map((src) => {
          const im = new Image();
          im.src = src;
          return im;
        });
        const loop = () => {
          if (currentModal !== "battle") return;
          f = (f + 1) % 4;
          if (ps) ps.src = playerImgsIdle[f % playerImgsIdle.length].src;
          if (es && demonIdle[f]) es.src = demonIdle[f].src;
          setTimeout(loop, 220);
        };
        loop();
        // イントロ フラッシュ
        const flash = document.createElement("div");
        flash.style.position = "absolute";
        flash.style.inset = "0";
        flash.style.background = "#fff";
        flash.style.animation = "bossFlash .8s ease forwards";
        document.getElementById("battleArea").appendChild(flash);
      }
      function renderBossResult(victory, reward, enemy) {
        const box = document.getElementById("battleResult");
        if (!box) return;
        if (victory) {
          box.innerHTML = `<div style='color:#ffd166;font-weight:600;'>討伐成功! +${
            reward?.goldGain || 0
          }G +${
            reward?.expGain || 0
          }EXP</div><button id='battleCloseBtn' style='margin-top:6px;background:#0d3b66;color:#fff;border:1px solid #1b4f7d;border-radius:6px;padding:4px 8px;font-size:11px;'>閉じる</button>`;
        } else {
          box.innerHTML = `<div style='color:#e63946;font-weight:600;'>敗北...</div><button id='battleCloseBtn' style='margin-top:6px;background:#3a506b;color:#fff;border:1px solid #4f6480;border-radius:6px;padding:4px 8px;font-size:11px;'>閉じる</button>`;
        }
        const btn = document.getElementById("battleCloseBtn");
        if (btn) btn.onclick = () => closeModal();
      }
      function appendBattleLog(line) {
        const box = document.getElementById("battleLog");
        if (!box) return;
        const d = document.createElement("div");
        d.textContent = line;
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
      }
      function setEnemyHpBar(hp, maxHp) {
        const t = document.getElementById("enemyHpText");
        const b = document.getElementById("enemyHpBar");
        if (t) t.textContent = `${hp}/${maxHp}`;
        if (b) b.style.width = ((hp / maxHp) * 100).toFixed(1) + "%";
      }
      async function playBattleSequence(enemy, events) {
        setEnemyHpBar(enemy.hp, enemy.maxHp);
        for (const ev of events) {
          await waitMs(480);
          if (ev.type === "player") {
            animateHit("playerSprite", "enemySprite");
            enemy.hp = ev.enemyHp;
            setEnemyHpBar(enemy.hp, enemy.maxHp);
            appendBattleLog(`あなたの攻撃 ${ev.dmg} ダメージ`);
          } else {
            animateHit("enemySprite", "playerSprite");
            appendBattleLog(`敵の攻撃 ${ev.dmg} ダメージ`);
          }
        }
      }
      function animateHit(attId, tId) {
        const a = document.getElementById(attId);
        const t = document.getElementById(tId);
        if (!a || !t) return;
        a.animate(
          [
            { transform: a.style.transform + " scale(1)" },
            { transform: a.style.transform + " scale(1.15)" },
            { transform: a.style.transform + " scale(1)" },
          ],
          { duration: 300, easing: "ease" }
        );
        t.animate(
          [
            { filter: "brightness(1)" },
            { filter: "brightness(3)" },
            { filter: "brightness(1)" },
          ],
          { duration: 300, easing: "ease" }
        );
      }
      function renderBattleResult(victory, reward) {
        const box = document.getElementById("battleResult");
        if (!box) return;
        if (victory) {
          box.innerHTML = `<div style='color:#ffd166;font-weight:600;'>勝利! +${
            reward?.goldGain || 0
          }G +${reward?.expGain || 0}EXP</div>`;
          if (reward?.levelUps?.length)
            box.innerHTML += `<div style='color:#06d6a0;'>LvUP → ${reward.levelUps.join(
              ","
            )}</div>`;
          box.innerHTML += `<button id='battleCloseBtn' style='margin-top:6px;background:#0d3b66;color:#fff;border:1px solid #1b4f7d;border-radius:6px;padding:4px 8px;font-size:11px;'>閉じる</button>`;
        } else {
          box.innerHTML = `<div style='color:#e63946;font-weight:600;'>敗北...</div><button id='battleCloseBtn' style='margin-top:6px;background:#3a506b;color:#fff;border:1px solid #4f6480;border-radius:6px;padding:4px 8px;font-size:11px;'>閉じる</button>`;
        }
        const btn = document.getElementById("battleCloseBtn");
        if (btn) btn.onclick = () => closeModal();
      }
      function waitMs(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }
      function actionInspect() {
        // 宝箱
        const chest = (state?.items || []).find(
          (it) => it.type === "chest" && it.x === player.x && it.y === player.y
        );
        if (chest && !chest.opened) {
          doAction("pickup", { x: player.x, y: player.y });
          return;
        }
        // ボス
        if (
          Math.abs(player.x - bossPos.x) <= 1 &&
          Math.abs(player.y - bossPos.y) <= 1
        ) {
          openModal("bossConfirm");
          return;
        }
        const nearInn =
          Math.abs(player.x - innPos.x) <= 1 &&
          Math.abs(player.y - innPos.y) <= 1;
        if (nearInn) {
          openModal("inn");
          return;
        }
        const nearShop =
          Math.abs(player.x - shopPos.x) <= 1 &&
          Math.abs(player.y - shopPos.y) <= 1;
        if (nearShop) {
          openModal("shop");
          return;
        }
        fadeMessage("何もない");
      }
      window.addEventListener("keydown", (e) => {
        const dirMap = {
          ArrowUp: "up",
          ArrowDown: "down",
          ArrowLeft: "left",
          ArrowRight: "right",
        };
        if (dirMap[e.key]) {
          e.preventDefault();
          if (currentModal) {
            modalNavigate(dirMap[e.key]);
          } else {
            movePlayerDir(dirMap[e.key]);
          }
        } else if (e.key === "a") {
          if (currentModal) modalConfirm();
          else actionInspect();
        } else if (e.key === "b") {
          // B でトグル
          dashOn = !dashOn;
          updateDashBtn();
        } else if (e.key === "Escape") {
          if (currentModal) closeModal();
          else openModal("settings");
        }
      });
      // keyup 不要 (トグル)
      // アクションボタン
      // 旧アクション群削除済み
      // ===== バーチャルコントローラー =====
      function bindHold(el) {
        const dir = el.dataset.dir;
        const start = () => {
          if (currentModal) {
            modalNavigate(dir);
          } else {
            heldDirs.add(dir);
          }
        };
        const end = () => heldDirs.delete(dir);
        el.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
            start();
          },
          { passive: false }
        );
        el.addEventListener("mousedown", (e) => {
          e.preventDefault();
          start();
        });
        [
          "touchend",
          "touchcancel",
          "mouseup",
          "mouseleave",
          "contextmenu",
        ].forEach((ev) => el.addEventListener(ev, end));
      }
      document.querySelectorAll(".dpad-btn").forEach(bindHold);
      // ダッシュ トグル (dashOn=true=高速, false=低速)
      let dashOn = true;
      const btnSettings = document.querySelector('[data-btn="settings"]');
      const btnDash = document.querySelector('[data-btn="dash"]');
      const btnInspect = document.querySelector('[data-btn="inspect"]');
      btnSettings.addEventListener("click", () => {
        if (currentModal === "settings") closeModal();
        else openModal("settings");
      });
      function updateDashBtn() {
        btnDash.classList.toggle("dash-on", dashOn);
        btnDash.classList.toggle("dash-off", !dashOn);
        btnDash.textContent = dashOn ? "走" : "遅";
      }
      btnDash.addEventListener("click", (e) => {
        e.preventDefault();
        dashOn = !dashOn;
        updateDashBtn();
      });
      updateDashBtn();
      btnInspect.addEventListener("click", () => {
        if (currentModal) modalConfirm();
        else actionInspect();
      });
      const heldDirs = new Set();
      function loopMove() {
        if (heldDirs.size && !currentModal) {
          const dir = [...heldDirs].slice(-1)[0];
          movePlayerDir(dir);
          if (dashOn) movePlayerDir(dir);
        }
        requestAnimationFrame(loopMove);
      }
      loopMove();

      // ===== モーダル管理 =====
      let currentModal = null;
      let modalFocus = 0;
      let modalListLength = 0;
      const overlay = document.getElementById("modalOverlay");
      const modalBody = document.getElementById("modalBody");
      const modalTitle = document.getElementById("modalTitle");
      document.getElementById("modalCloseBtn").onclick = () => closeModal();
      function openModal(type) {
        currentModal = type;
        modalFocus = 0;
        overlay.style.display = "flex";
        refreshModal();
      }
      function closeModal() {
        currentModal = null;
        overlay.style.display = "none";
      }
      function modalItems() {
        if (currentModal === "settings") {
          return [];
        }
        if (currentModal === "battle") return [];
        if (currentModal === "inn") {
          return ["はい", "いいえ"];
        }
        if (currentModal === "bossConfirm") {
          return ["戦う", "やめる"];
        }
        if (currentModal === "shop") {
          return shopCatalog.map((i) => i.id);
        }
        return [];
      }
      function modalNavigate(dir) {
        const items = modalItems();
        if (!items.length) return;
        if (dir === "up") {
          modalFocus = (modalFocus - 1 + items.length) % items.length;
          refreshModalFocus();
        } else if (dir === "down") {
          modalFocus = (modalFocus + 1) % items.length;
          refreshModalFocus();
        }
      }
      function modalConfirm() {
        if (!currentModal) return;
        if (currentModal === "settings") {
          /* no selection; maybe ignore */ return;
        }
        const items = modalItems();
        if (!items.length) return;
        const choice = items[modalFocus];
        if (currentModal === "inn") {
          if (choice === "はい") {
            doAction("heal");
          }
          closeModal();
          return;
        }
        if (currentModal === "bossConfirm") {
          if (choice === "戦う") startBossBattle();
          closeModal();
          return;
        }
        if (currentModal === "shop") {
          const item = shopCatalog[modalFocus];
          if (item) {
            if (!(state.equips || []).includes(item.type))
              doAction("equip-" + item.type);
            else fadeMessage("既に所持");
          }
          refreshModal();
          return;
        }
      }
      function refreshModal() {
        if (!currentModal) return;
        const equips = state?.equips || [];
        if (currentModal === "settings") {
          modalTitle.textContent = "設定";
          modalBody.innerHTML = `<div style='display:flex;flex-direction:column;gap:8px;'>
        <button id='manualSaveBtn' style='background:#0d3b66;color:#fff;border:1px solid #1b4f7d;border-radius:6px;padding:6px 10px;font-size:12px;'>手動セーブ</button>
        <div style='font-size:12px;'>Lv${state.level} HP ${state.hp}/${
            state.maxHp
          } EXP ${state.exp}/${state.nextExp} G:${state.gold}</div>
        <div style='font-size:12px;'>ATK ${state.atk}</div>
        <div style='font-size:12px;'>装備: ${equips.join(",") || "-"}</div>
      </div>`;
          document.getElementById("manualSaveBtn").onclick = async () => {
            const r = await api("save");
            if (r?.state) {
              state = r.state;
              updateStats();
              fadeMessage("セーブ完了");
            }
          };
        } else if (currentModal === "inn") {
          modalTitle.textContent = "宿屋";
          modalBody.innerHTML = `<p style='margin:0 0 6px;font-size:12px;'>全回復しますか？ (10%/最低1G)</p>${menuListHtml(
            ["はい", "いいえ"]
          )}`;
        } else if (currentModal === "bossConfirm") {
          modalTitle.textContent = "ボス";
          modalBody.innerHTML = `<p style='margin:0 0 6px;font-size:12px;'>Lv10000 / HP1200 のラスボスに挑みますか？</p>${menuListHtml(
            ["戦う", "やめる"]
          )}`;
        } else if (currentModal === "shop") {
          modalTitle.textContent = "武器屋";
          modalBody.innerHTML = shopListHtml();
        } else if (currentModal === "battle") {
          /* battle表示は startBattle 内 */
        }
        refreshModalFocus();
      }
      function refreshModalFocus() {
        const wrap = modalBody;
        const focusables = wrap.querySelectorAll("[data-menu-index]");
        focusables.forEach((el) => {
          el.classList.toggle(
            "focus",
            Number(el.getAttribute("data-menu-index")) === modalFocus
          );
        });
      }
      function menuListHtml(arr) {
        return `<ul style='list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:4px;'>${arr
          .map(
            (t, i) =>
              `<li data-menu-index='${i}' style="padding:6px 8px;border:1px solid #2f4e6d;border-radius:6px;background:#1c2541;">${t}</li>`
          )
          .join("")}</ul>`;
      }
      const shopCatalog = [
        { type: "dagger", label: "短剣", atk: 4, cost: 40 },
        { type: "sword", label: "剣", atk: 5, cost: 60 },
        { type: "staff", label: "杖", atk: 7, cost: 70 },
        { type: "axe", label: "戦斧", atk: 8, cost: 110 },
        { type: "spear", label: "槍", atk: 9, cost: 120 },
        { type: "wand", label: "ワンド", atk: 9, cost: 125 },
        { type: "longsword", label: "ロングソード", atk: 10, cost: 150 },
        { type: "mystic_staff", label: "魔導杖", atk: 12, cost: 200 },
        { type: "greatsword", label: "グレートソード", atk: 14, cost: 240 },
        { type: "armor", label: "防具", hp: 15, cost: 70 },
        { type: "plate_armor", label: "プレート", hp: 30, cost: 140 },
      ];
      function shopListHtml() {
        return `<div style='display:flex;flex-direction:column;gap:6px;'>${shopCatalog
          .map((it, i) => {
            const owned = (state?.equips || []).includes(it.type);
            const canBuy = (state?.gold || 0) >= it.cost;
            const statText = it.atk ? `ATK+${it.atk}` : `HP+${it.hp}`;
            const badge = owned ? "済" : canBuy ? "購入" : "不足";
            const badgeStyle = owned
              ? "color:#06d6a0;font-weight:600;"
              : canBuy
              ? "color:#ffd166;"
              : "color:#777;";
            return `<div data-menu-index='${i}' style="display:flex;flex-direction:column;gap:2px;padding:6px 8px;border:1px solid #2f4e6d;border-radius:6px;background:#1c2541;font-size:12px;">
            <div style='display:flex;justify-content:space-between;align-items:center;'>
              <span>${
                it.label
              } <span style='font-size:10px;opacity:.7;'>(${statText})</span></span>
              <span style='font-size:11px;${badgeStyle}'>${badge}</span>
            </div>
            <div style='font-size:10px;display:flex;justify-content:space-between;opacity:.8;'>
              <span>${it.cost}G</span>
              <span>${owned ? "所持済" : ""}</span>
            </div>
          </div>`;
          })
          .join("")}</div>`;
      }

      // ===== 初期化 =====
      initPlayer();
      resizeCanvasScale();
    </script>
  </body>
</html>
