<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
    />
    <title>ミニRPG</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body.rpg-body {
        background: #0b132b;
        color: #fff;
        font-family: "Inter", sans-serif;
        overflow: hidden;
      }
      .rpg-topbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 46px;
        background: #1c2541;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0 10px;
        font-size: 13px;
        z-index: 10;
      }
      .rpg-topbar select {
        background: #3a506b;
        color: #fff;
        border: 1px solid #4f6480;
        border-radius: 6px;
        padding: 4px 6px;
      }
      .rpg-wrapper {
        position: fixed;
        inset: 46px 0 0 0;
        display: flex;
      }
      .rpg-left {
        flex: 0 0 70vw;
        max-width: 820px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .rpg-canvas-wrap {
        position: relative;
        image-rendering: pixelated;
      }
      #rpgCanvas {
        background: #14213d;
        box-shadow: 0 0 0 4px #222, 0 0 18px #000;
        border-radius: 4px;
        image-rendering: pixelated;
      }
      .rpg-right {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 8px 10px;
        overflow: auto;
        background: linear-gradient(180deg, #1c2541, #0b132b);
      }
      .rpg-panel {
        background: #243b55;
        border: 1px solid #2f4e6d;
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 12px;
        line-height: 1.4;
      }
      .rpg-panel h3 {
        margin: 0 0 4px;
        font-size: 13px;
        letter-spacing: 0.5px;
      }
      #rpgLog {
        max-height: 220px;
        overflow: auto;
        font-family: ui-monospace, monospace;
        background: #0d1b2a;
        border: 1px solid #223246;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 11px;
      }
      .rpg-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .rpg-actions button {
        flex: 1 1 calc(50% - 4px);
        background: #3a506b;
        color: #fff;
        border: 1px solid #4f6480;
        border-radius: 6px;
        padding: 6px 4px;
        font-size: 11px;
        cursor: pointer;
        letter-spacing: 0.5px;
      }
      .rpg-actions button:active {
        transform: translateY(2px);
      }
      .badge {
        display: inline-block;
        background: #ffb703;
        color: #222;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 9999px;
        font-size: 10px;
        margin-left: 4px;
      }
      .encounter-flash {
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at center,
          rgba(255, 255, 255, 0.9),
          rgba(255, 255, 255, 0)
        );
        pointer-events: none;
        animation: flash 0.6s ease forwards;
      }
      @keyframes flash {
        0% {
          opacity: 0;
        }
        30% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
      .hp-bar {
        height: 6px;
        background: #112031;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 4px;
      }
      .hp-bar span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, #06d6a0, #118ab2);
      }
      .enemy-window {
        position: absolute;
        top: -56px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #fff;
        font-family: ui-monospace, monospace;
      }
      .fade-msg {
        position: absolute;
        bottom: 6px;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 11px;
        color: #fff;
        animation: fadeMsg 2.2s ease forwards;
        pointer-events: none;
        text-shadow: 0 0 4px #000;
      }
      @keyframes fadeMsg {
        0% {
          opacity: 0;
          transform: translateY(8px);
        }
        15% {
          opacity: 1;
          transform: translateY(0);
        }
        85% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body class="rpg-body">
    <div class="rpg-topbar" id="topBar">
      <button class="rpg-btn" onclick="location.href='/'">戻る</button>
      <span id="rpgStatusText" class="rpg-status-text" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
      <button id="toggleAutoEncounter" class="rpg-btn warn">自動エンカON</button>
    </div>
    <div class="rpg-wrapper" style="inset:46px 0 0 0;display:flex;">
      <div class="rpg-canvas-wrap" id="canvasWrap">
        <canvas id="rpgCanvas" width="640" height="360"></canvas>
        <div class="enemy-window" id="enemyWindow" style="display:none"></div>
        <div class="fade-msg" id="fadeMsg" style="display:none"></div>
      </div>
      <div class="rpg-sidepanels" style="width:260px;display:flex;flex-direction:column;gap:8px;padding:8px 10px;overflow:auto;background:linear-gradient(180deg,#1c2541,#0b132b);">
        <div class="rpg-panel compact" id="panelStats" style="min-height:86px">
          <div id="statsBox">-</div>
          <button id="manualSaveBtn" class="rpg-btn mini" style="margin-top:6px">手動セーブ</button>
        </div>
        <div class="rpg-panel compact" id="panelActions">
          <div class="rpg-actions" style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;">
            <button data-act="battle">戦闘</button>
            <button data-act="heal">宿屋</button>
            <button data-act="equip-sword">剣</button>
            <button data-act="equip-armor">防具</button>
            <button data-act="boss" class="wide" style="grid-column:span 2">ボス</button>
            <button data-act="pickup" class="wide" style="grid-column:span 3">宝箱/調べる</button>
          </div>
        </div>
        <div class="rpg-panel" id="panelLog">
          <h3 style="margin:0 0 4px;font-size:13px;">ログ</h3>
          <div id="rpgLog" style="max-height:220px;overflow:auto;font-family:ui-monospace,monospace;background:#0d1b2a;border:1px solid #223246;padding:6px 8px;border-radius:6px;font-size:11px;"></div>
        </div>
      </div>
      <div class="vc-left" id="vcLeft" style="position:fixed;left:16px;bottom:32px;z-index:20;">
        <div class="dpad" style="position:relative;width:140px;height:140px;">
          <button data-dir="up" class="dpad-btn" style="top:0;left:50%;transform:translate(-50%,0);"></button>
          <button data-dir="left" class="dpad-btn" style="left:0;top:50%;transform:translate(0,-50%);"></button>
          <button data-dir="right" class="dpad-btn" style="right:0;top:50%;transform:translate(0,-50%);"></button>
          <button data-dir="down" class="dpad-btn" style="bottom:0;left:50%;transform:translate(-50%,0);"></button>
        </div>
      </div>
      <div class="vc-right" id="vcRight" style="position:fixed;right:32px;bottom:48px;z-index:20;display:flex;gap:18px;">
        <div class="buttons" style="position:relative;width:180px;height:160px;">
          <button data-btn="a" class="btn-round btn-a" style="right:0;bottom:14px;">A</button>
          <button data-btn="b" class="btn-round btn-b" style="right:56px;top:0;">B</button>
          <button data-btn="x" class="btn-round btn-x" style="left:0;bottom:14px;">X</button>
          <button data-btn="y" class="btn-round btn-y" style="right:56px;bottom:80px;">Y</button>
        </div>
      </div>
    </div>
    <script>
      // ===== 基本設定 =====
      const API = "/api/games/rpg";
      const params = new URLSearchParams(location.search);
      const currentPlayerId = Number(params.get('staffId')) || Number(localStorage.getItem('gameSelectedStaffId')) || null;
      if(!currentPlayerId){ alert('スタッフ未選択: ゲームハブから入ってください'); }
      let state = null; let autoEncounter = true; let walking=false; let encounterStep=0;
      const canvas = document.getElementById('rpgCanvas'); const ctx = canvas.getContext('2d');
      const TILE = 16; const mapW = 40, mapH = 22; // 640x352 使用
      // 0 floor,1 wall,2 inn,3 shop,4 chestClosed,5 chestOpen
      const world = Array.from({length: mapH},(_,y)=>Array.from({length:mapW},(_,x)=> (x===0||y===0||x===mapW-1||y===mapH-1)?1:0));
      const innPos={x:6,y:6}; const shopPos={x:10,y:6}; world[innPos.y][innPos.x]=2; world[shopPos.y][shopPos.x]=3;
      const chestSeeds=[{x:14,y:5},{x:20,y:10},{x:30,y:8}]; chestSeeds.forEach(c=>{ if(world[c.y][c.x]===0) world[c.y][c.x]=4; });
      // タイル & プレイヤースプライト (配置はユーザーが public/assets/rpg/ に配置)
      const tilesImg = new Image(); tilesImg.src='/assets/rpg/tileset.png';
      const playerImg = new Image(); playerImg.src='/assets/rpg/player.png';
      const tileMap = { 0:[0,0], 1:[1,0], 2:[10,4], 3:[11,4], 4:[4,6], 5:[5,6] };
      let player = {x:2,y:2,dir:0,frame:0}; // dir 0down1left2right3up
      // ===== ユーティリティ =====
      function log(msg){ const box=document.getElementById('rpgLog'); const d=document.createElement('div'); d.textContent=new Date().toLocaleTimeString()+" "+msg; box.prepend(d); while(box.children.length>120) box.removeChild(box.lastChild); }
      function fadeMessage(msg){ const el=document.getElementById('fadeMsg'); el.textContent=msg; el.style.display='block'; el.classList.remove('run'); void el.offsetWidth; el.classList.add('run'); setTimeout(()=>el.style.display='none',2200); }
      function flashEncounter(){ const f=document.createElement('div'); f.className='encounter-flash'; canvas.parentElement.appendChild(f); setTimeout(()=>f.remove(),600); }
      function renderStatus(){ if(!state){ document.getElementById('rpgStatusText').textContent='-'; return;} document.getElementById('rpgStatusText').textContent=`Lv${state.level} HP ${state.hp}/${state.maxHp} G:${state.gold}`; }
      function updateStats(){ if(!state){ document.getElementById('statsBox').textContent='-'; return;} const {level,hp,maxHp,gold,exp,nextExp,atk,equips,bossDefeated}=state; document.getElementById('statsBox').innerHTML=`Lv${level} HP ${hp}/${maxHp}<div class='hp-bar'><span style='width:${((hp/maxHp)*100).toFixed(1)}%'></span></div>EXP ${exp}/${nextExp} G:${gold}<br>ATK:${atk} 装備:${(equips||[]).join(',')||'-'} ${bossDefeated?"<span class=badge>BOSS</span>":''}`; renderStatus(); }
      async function api(action,payload){ if(!currentPlayerId) return; const body={staffId:currentPlayerId,action,payload}; const res=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); if(!res.ok){ log('通信失敗:'+action); return null;} return await res.json(); }
      async function initPlayer(){ if(!currentPlayerId) return; const r = await api('init'); if(r&&r.state){ state=r.state; updateStats(); log('ロード完了'); draw(); }}
      async function doAction(k,payload){ if(!state) return; let r=null; if(k==='battle'){ r=await api('battle'); if(r?.state){ state=r.state; updateStats(); log('戦闘:'+(r.result?.victory?'勝利':'敗北')); }} else if(k==='heal'){ r=await api('heal'); if(r?.state){ state=r.state; updateStats(); log(r.result?.msg||'回復'); }} else if(k==='equip-sword'){ r=await api('equip',{type:'sword'}); if(r?.state){ state=r.state; updateStats(); log(r.result?.msg); }} else if(k==='equip-armor'){ r=await api('equip',{type:'armor'}); if(r?.state){ state=r.state; updateStats(); log(r.result?.msg); }} else if(k==='boss'){ r=await api('boss'); if(r?.state){ state=r.state; updateStats(); log('ボス戦:'+(r.result?.victory?'勝利!':(r.result?.log?.slice(-1)[0]||''))); }} else if(k==='pickup'){ r=await api('pickup',payload); if(r?.state){ state=r.state; updateStats(); log(r.result?.msg||'取得'); }} if(r?.state) draw(); }
      function attemptEncounter(){ if(!autoEncounter) return; if(Math.random()<0.18){ walking=false; flashEncounter(); fadeMessage('エンカウント!'); doAction('battle'); } }
      // ===== 描画 =====
      function draw(){ ctx.imageSmoothingEnabled=false; ctx.clearRect(0,0,canvas.width,canvas.height); for(let y=0;y<mapH;y++){ for(let x=0;x<mapW;x++){ let t=world[y][x]; if(t===4||t===5){ const chest=(state?.items||[]).find(it=>it.type==='chest'&&it.x===x&&it.y===y); if(chest) t= chest.opened?5:4; } drawTile(t,x,y); }} if(state) drawPlayer(); updateProximityUI(); }
      function drawTile(t,x,y){ const uv=tileMap[t]||tileMap[0]; if(!tilesImg.complete){ ctx.fillStyle='#222'; ctx.fillRect(x*TILE,y*TILE,TILE,TILE); return;} ctx.drawImage(tilesImg, uv[0]*TILE, uv[1]*TILE, TILE, TILE, x*TILE, y*TILE, TILE, TILE); }
      function drawPlayer(){ if(!playerImg.complete){ ctx.fillStyle='#ffb703'; ctx.fillRect(player.x*TILE+2, player.y*TILE+2, TILE-4, TILE-4); return;} const fw=TILE, fh=TILE; const sy=player.dir; const sx=player.frame%4; ctx.drawImage(playerImg, sx*fw, sy*fh, fw, fh, player.x*TILE, player.y*TILE, fw, fh); }
      // 近接インジケータ
      let proxEl=document.getElementById('proxUI'); if(!proxEl){ proxEl=document.createElement('div'); proxEl.id='proxUI'; proxEl.style.position='absolute'; proxEl.style.left='8px'; proxEl.style.top='8px'; proxEl.style.zIndex='5'; proxEl.style.display='flex'; proxEl.style.gap='6px'; canvas.parentElement.appendChild(proxEl);} 
      function updateProximityUI(){ if(!state){ proxEl.innerHTML=''; return;} const nearInn=Math.abs(player.x-innPos.x)<=1&&Math.abs(player.y-innPos.y)<=1; const nearShop=Math.abs(player.x-shopPos.x)<=1&&Math.abs(player.y-shopPos.y)<=1; proxEl.innerHTML=[ nearInn?'<span class="badge" style="background:#2a9d8f">宿屋</span>':'', nearShop?'<span class="badge" style="background:#a44f9d">店</span>':'' ].filter(Boolean).join(''); }
      // ===== 移動/操作 =====
      function movePlayerDir(dir){ let dx=0,dy=0; if(dir==='up'){dy=-1;player.dir=3;} else if(dir==='down'){dy=1;player.dir=0;} else if(dir==='left'){dx=-1;player.dir=1;} else if(dir==='right'){dx=1;player.dir=2;} const nx=player.x+dx, ny=player.y+dy; if(nx<1||ny<1||nx>=mapW-1||ny>=mapH-1) return; if(world[ny][nx]===1) return; player.x=nx; player.y=ny; player.frame=(player.frame+1)%60; walking=true; encounterStep=(encounterStep+1)%4; if(encounterStep===0) attemptEncounter(); draw(); }
      function actionPickup(){ const chest=(state?.items||[]).find(it=>it.type==='chest'&&it.x===player.x&&it.y===player.y); if(chest && !chest.opened){ doAction('pickup',{x:player.x,y:player.y}); return;} const nearInn=Math.abs(player.x-innPos.x)<=1&&Math.abs(player.y-innPos.y)<=1; if(nearInn){ doAction('heal'); return;} const nearShop=Math.abs(player.x-shopPos.x)<=1&&Math.abs(player.y-shopPos.y)<=1; if(nearShop){ if(!(state.equips||[]).includes('sword')) doAction('equip-sword'); else if(!(state.equips||[]).includes('armor')) doAction('equip-armor'); return;} fadeMessage('何もない'); }
      window.addEventListener('keydown',e=>{ if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){ e.preventDefault(); movePlayerDir(e.key.replace('Arrow','').toLowerCase()); } else if(e.key==='a'){ doAction('battle'); } else if(e.key==='x'){ actionPickup(); } else if(e.key==='b'){ autoEncounter=!autoEncounter; document.getElementById('toggleAutoEncounter').textContent= autoEncounter?'自動エンカON':'自動エンカOFF'; } else if(e.key==='y'){ doAction('boss'); } });
      // アクションボタン
      document.querySelectorAll('.rpg-actions button').forEach(b=> b.addEventListener('click',()=>{ const act=b.getAttribute('data-act'); if(act==='pickup') actionPickup(); else doAction(act); }));
      document.getElementById('toggleAutoEncounter').addEventListener('click',()=>{ autoEncounter=!autoEncounter; document.getElementById('toggleAutoEncounter').textContent= autoEncounter?'自動エンカON':'自動エンカOFF'; fadeMessage(autoEncounter?'自動エンカ ON':'自動エンカ OFF'); });
      document.getElementById('manualSaveBtn').onclick= async ()=>{ if(!currentPlayerId){ alert('プレイヤー未選択'); return;} const r=await api('save'); if(r?.state){ state=r.state; updateStats(); log('手動セーブ完了'); }};
      // ===== バーチャルコントローラー =====
      const heldDirs=new Set(); function loopMove(){ if(heldDirs.size){ const dir=[...heldDirs].slice(-1)[0]; movePlayerDir(dir); } requestAnimationFrame(loopMove);} loopMove();
      function bindHold(el){ const dir=el.dataset.dir; const start=()=>heldDirs.add(dir); const end=()=>heldDirs.delete(dir); el.addEventListener('touchstart',e=>{e.preventDefault();start();},{passive:false}); el.addEventListener('mousedown',e=>{e.preventDefault();start();}); ['touchend','touchcancel','mouseup','mouseleave','contextmenu'].forEach(ev=> el.addEventListener(ev,end)); }
      document.querySelectorAll('.dpad-btn').forEach(bindHold);
      document.querySelectorAll('.buttons button[data-btn]').forEach(b=>{ b.addEventListener('click',()=>{ const t=b.dataset.btn; if(t==='a') doAction('battle'); else if(t==='b'){ autoEncounter=!autoEncounter; document.getElementById('toggleAutoEncounter').textContent= autoEncounter?'自動エンカON':'自動エンカOFF'; fadeMessage(autoEncounter?'自動エンカ ON':'自動エンカ OFF'); } else if(t==='x') actionPickup(); else if(t==='y') doAction('boss'); }); });
      // ===== 初期化 =====
      initPlayer();
    </script>
  </body>
</html>
