# PAè©•ä¾¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v3.x

æ–°äººæ•™è‚² / ã‚¹ã‚­ãƒ«è©•ä¾¡ / é€²æ—å…±æœ‰ã‚’ 1 ç”»é¢ã§æ‰±ãˆã‚‹è»½é‡ Web ã‚¢ãƒ—ãƒªã€‚iPad æ¨ªå‘ãæœ€é©åŒ–ãƒ»ã‚µãƒ¼ãƒãƒ¬ã‚¹ãƒ»æœ€å°ä¾å­˜ã§é«˜é€Ÿè¡¨ç¤ºã€‚

## ç‰¹å¾´

- ã‚¿ãƒ–: å…±æœ‰ãƒ¡ãƒ¢ / ã‚¹ã‚¿ãƒƒãƒ• / è©•ä¾¡é …ç›® / ãƒ­ã‚°
- è©•ä¾¡ãƒ¢ãƒ¼ãƒ€ãƒ«: ãƒ­ãƒ¼ã‚«ãƒ«åæ˜  â†’ é–‰ã˜ã‚‹æ™‚ã«ä¸€æ‹¬ä¿å­˜
- è©•ä¾¡é …ç›®èª¬æ˜: è¡Œé ­ "- " è‡ªå‹•ä»˜ä¸ã— `<br>` åŒ–
- å…±æœ‰ãƒ¡ãƒ¢: 1 ç§’ãƒ‡ãƒã‚¦ãƒ³ã‚¹è‡ªå‹•ä¿å­˜ (ç©ºæ–‡å­—ã‚‚å±¥æ­´)
- ãƒ­ã‚°: æœ€æ–° 200 ä»¶ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ / è¤‡æ•°è¡Œè¡¨ç¤º
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: å…±é€šã‚µãƒ‹ã‚¿ã‚¤ã‚º

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- ãƒ•ãƒ­ãƒ³ãƒˆ: Vanilla JS / HTML / CSS
- ã‚µãƒ¼ãƒ: Vercel Functions (Node.js)
- ORM / DB: Prisma + PostgreSQL
- ãƒ•ã‚©ãƒ³ãƒˆ: Inter / Font Awesome
- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: ãªã—

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

| Model | ä¸»ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‚™è€ƒ |
|-------|----------------|------|
| Staff | id, name, kana, position, joined, birthDate, createdAt | joined/birthDate ã¯ Date |
| Criteria | id, name, description, category, sortOrder, createdAt | category æ—¢å®š 'å…±é€š'; description ã¯ `<br>` ä¿å­˜å¯ |
| Evaluation | id, staffId, criteriaId, status, score?, comments?, createdAt | status: not-started / learning / done; comments JSON({testedBy, testedAt}) |
| Log | id, event, message, createdAt | æœ€æ–° 200 ä»¶ä¿æŒ |

`comments` JSON ä¾‹:

```json
{
    "testedBy": 12,
    "testedAt": "2025-08-12T05:18:40.000Z"
}
```

## ğŸ” ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ–¹é‡

`api/_sanitize.js` ã® `sanitizeContent(raw, { allowBr })` ã‚’åˆ©ç”¨ã€‚

- script / iframe / object / embed / svg / link / meta ã‚¿ã‚°é™¤å»
- `javascript:` ã‚¹ã‚­ãƒ¼ãƒ é™¤å»
- on* ã‚¤ãƒ™ãƒ³ãƒˆå±æ€§é™¤å»
- `allowBr=true` ã®å ´åˆã®ã¿ `<br>` ã‚’ç´ é€šã— (ä»–ã¯ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—)
- é©ç”¨å¯¾è±¡: staff.name/kana/position, criteria.name/description(allowBr), evaluation.status, shared-note æœ¬æ–‡

| HTTP | æ„å‘³ |
|------|------|
| 200  | æˆåŠŸ |
| 400  | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ / ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸è¶³ |
| 405  | ãƒ¡ã‚½ãƒƒãƒ‰ä¸è¨±å¯ |
| 500  | ã‚µãƒ¼ãƒå†…éƒ¨ã‚¨ãƒ©ãƒ¼ |

---

### 1. ã‚¹ã‚¿ãƒƒãƒ• API `/api/staff`

| Method | ç”¨é€”           | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿       | Body ä¾‹                                                                 | æˆ»ã‚Šå€¤ |
|--------|----------------|------------------|-------------------------------------------------------------------------|--------|
| POST   | æ–°è¦è¿½åŠ        | ãªã—             | `{ "name":"å±±ç”°", "kana":"ãƒ¤ãƒãƒ€", "position":"ç¤¾å“¡", "birth_date":"2001-04-24" }` | `{ id, message }` |
| PUT    | æ›´æ–°           | `?id=number`     | ä¸Šè¨˜ã¨åŒå½¢å¼ (æœªæŒ‡å®šã¯å¤‰æ›´ãªã—)                                         | `{ message }` |
| DELETE | å‰Šé™¤           | `?id=number`     | -                                                                       | `{ message, deletedEvaluations }` |

ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆ: `staff:create`, `staff:update`, `staff:delete`

---

### 2. è©•ä¾¡é …ç›® API `/api/criteria`

| Method | ç”¨é€”                    | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿        | Body                                                                                                                 | å‚™è€ƒ |
|--------|-------------------------|-------------------|----------------------------------------------------------------------------------------------------------------------|------|
| POST   | è¿½åŠ                     | ãªã—              | `{ "name":"ãƒ¬ã‚¸æ“ä½œ", "category":"ãƒ›ãƒ¼ãƒ«", "description":"- ãƒ­ã‚°ã‚¤ãƒ³<br>- ä¼šè¨ˆ" }`                             | name å¿…é ˆã€‚category ã¯ {å…±é€š/ãƒ›ãƒ¼ãƒ«/ã‚­ãƒƒãƒãƒ³/ãã®ä»–} ä»¥å¤–ã¯å…±é€š |
| PUT    | ä¸¦ã³æ›¿ãˆ or å˜ä¸€æ›´æ–°    | `?id` (å˜ä¸€æ™‚)    | ä¸¦ã³æ›¿ãˆ: `{ "items": [{"id":3,"sortOrder":0}, ...] }` ã¾ãŸã¯ `{ "order": [{"id":3,"sort_order":1}, ...] }` / å˜ä¸€æ›´æ–°: `{ "name":..., "category":..., "description":... }` | ä¸¦ã³æ›¿ãˆã¯é…åˆ—é †ã‚’æ¡ç”¨ |
| DELETE | å‰Šé™¤                    | `?id=number`      | -                                                                                                                    | - |

ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆ: `criteria:create`, `criteria:update`, `criteria:delete`, `criteria:reorder`

---

### 3. è©•ä¾¡ API `/api/evaluations`

| Method | ç”¨é€”                   | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿            | Body                                                                                       | å‚™è€ƒ |
|--------|------------------------|-----------------------|--------------------------------------------------------------------------------------------|------|
| GET    | å…¨è©•ä¾¡ (é™é †)          | ãªã—                  | -                                                                                          | ä¸€è¦§ç”¨é€” |
| POST   | æ–°è¦ä½œæˆ               | ãªã—                  | `{ "staff_id":1, "criteria_id":5, "status":"learning", "changed_by":2 }`             | status çœç•¥æ™‚ `learning` |
| PUT    | æ›´æ–° (ç„¡ã‘ã‚Œã°ä½œæˆ)    | ãªã—                  | `{ "staffId":1, "criteriaId":5, "status":"done", "changedBy":2 }`                  | upsert å‹•ä½œ |
| DELETE | å˜ä¸€å‰Šé™¤               | `?id=number`          | -                                                                                          | - |

ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤: `not-started` / `learning` / `done` (UI è¡¨ç¤º: æœªç€æ‰‹ / å­¦ç¿’ä¸­ / ç¿’å¾—æ¸ˆã¿)

ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆ: `evaluation:create`, `evaluation:update`, `evaluation:delete`

---

### 4. è©•ä¾¡ä¸€æ‹¬æ›´æ–° API `/api/evaluations-batch`

| Method | ç”¨é€”                                   | Body ä¾‹ |
|--------|----------------------------------------|---------|

å‹•ä½œ: `status` ä¸æ­£å€¤â†’ `not-started` ã«æ­£è¦åŒ–ã€‚`test.testedBy` (æ•°å€¤) ã§ comments JSON `{ testedBy, testedAt }` ä¿å­˜ã€‚`test.clear=true` ã§å‰Šé™¤ã€‚

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹: `{ "message":"batch updated", "count":12 }`

ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆ: `evaluation:batch-update` (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›¸å¼: `è©•ä¾¡æ›´æ–°\nå¤‰æ›´è€…ï¼š<åå‰>\nã‚¹ã‚¿ãƒƒãƒ•ï¼š<è¤‡æ•°>\nä»¶æ•°ï¼šN\né …ç›®ï¼š<criteriaä¸€è¦§>`)

---

### 5. ã‚¹ã‚¿ãƒƒãƒ•é€²æ—é›†è¨ˆ API `/api/staff-progress`

| ãƒ¢ãƒ¼ãƒ‰   | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿       | æˆ»ã‚Šå€¤ä¾‹ |
|----------|------------------|----------|
| å€‹åˆ¥ä¸€è¦§ | `?staffId` ä»»æ„  | `[ { staffId, totalCriteria, progressPercent, counts:{done,learning,notStarted}, tested } ]` |

`progressPercent = (tested / totalCriteria) * 100` (ä¸¸ã‚)

---

### 6. ãƒ­ã‚° API `/api/logs`

| Method | ç”¨é€”         | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿                | Body ä¾‹                            | å‚™è€ƒ |
|--------|--------------|---------------------------|------------------------------------|------|
| POST   | ä»»æ„ãƒ­ã‚°è¿½åŠ  | ãªã—                      | `{ "event":"custom", "message":"å†…å®¹" }` | è¿½åŠ å¾Œ 200 ä»¶ã« prune |

`addLog()` ä»•æ§˜: ç©º message ã¯ shared-note ã®ã¿è¨±å®¹ã€‚ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å¤ã„é †å‰Šé™¤ã€‚

---

### 7. å…±æœ‰ãƒ¡ãƒ¢ API `/api/shared-note`

| Method | ç”¨é€”       | Body ä¾‹                 | å‚™è€ƒ |
|--------|------------|-------------------------|------|
| POST   | ä¿å­˜       | `{ "content":"æ–‡å­—åˆ—" }` | 15000 æ–‡å­—è¶…ã¯æœ«å°¾ `...[çœç•¥]` ä»˜ä¸ã€‚ç©ºæ–‡å­—ã‚‚ä¿å­˜ |

ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆ: `shared-note` (æœ¬æ–‡å…ˆé ­è¡Œã« "ãƒ¡ãƒ¢æ›´æ–°")

---

### 8. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ API `/api/export`

| Method | ç”¨é€”            | å‚™è€ƒ |
|--------|-----------------|------|

---

### 9. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ `/api/health`

| Method | ç”¨é€”            | å‚™è€ƒ |
|--------|-----------------|------|
| POST   | ãƒ‡ãƒãƒƒã‚°æŒ¿å…¥     | `?action=debug-insert` ã§ staff 1 è¡Œè¿½åŠ  |

---

### 10. å†…éƒ¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

- `_log.js`: `addLog(event, message)` è¿½åŠ  & 200ä»¶åˆ¶é™
- `_sanitize.js`: ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå…±é€šé–¢æ•°

## ğŸ§ª ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»

`not-started` â†’ (ã‚¯ãƒªãƒƒã‚¯) â†’ `learning` â†’ (ã‚¯ãƒªãƒƒã‚¯) â†’ `done` â†’ (ã‚¯ãƒªãƒƒã‚¯) â†’ `not-started`

ãƒ†ã‚¹ãƒˆå®Œäº†ã¯ status ã‚’å¤‰ãˆãš `comments` ã®ã¿ä»˜å¸¯ç®¡ç†ã€‚

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

Issuesã¸
