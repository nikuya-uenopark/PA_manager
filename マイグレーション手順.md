# マイグレーション手順 (Prisma / PostgreSQL)

学習と実務両対応。まず通常フロー、その後今回行った特殊 (baseline 再構築 + 手動テーブル作成) 手順を詳述します。

---

## 0. 用語ざっくり

| 用語      | 意味                                                           |
| --------- | -------------------------------------------------------------- |
| migration | `prisma/migrations/<timestamp_name>` 配下の SQL / meta         |
| shadow DB | `prisma migrate dev` が差分検証用に一時作成する空 DB           |
| baseline  | 「この時点が初期状態」と Prisma に教えるための最初の包括的 SQL |
| resolve   | 実際には SQL を実行せず「適用済み」マークだけ付ける操作        |

---

## 1. 通常フロー (新しいモデル/カラムを追加するだけの場合)

1. 依存導入 / 最新化
   ```console
   npm install
   ```
2. `.env` の `DATABASE_URL` 確認 (Neon は `?sslmode=require` 必須)  
   例: `postgresql://USER:PASSWORD@HOST:5432/DB?sslmode=require`
3. スキーマ編集 (`prisma/schema.prisma`)
4. 状態確認
   ```console
   npx prisma migrate status
   ```
   - Pending が無い & エラー無しを確認。
5. マイグレーション生成 + 適用 (開発環境)
   ```console
   npx prisma migrate dev --name <change_name>
   ```
6. 本番 (又はデプロイ環境) で適用
   ```console
   npx prisma migrate deploy
   ```
7. Prisma Client 再生成は `migrate dev` で自動。単独なら:
   ```console
   npx prisma generate
   ```

---

## 2. 今回直面した問題の背景

初期の 2 つのマイグレーションは **手書きの DO $$ ブロック** を含み、`Staff` テーブルが存在しないとエラーを `RAISE EXCEPTION` します。Shadow DB は「空 → 1 個目 → 2 個目 …」と順番に適用しますが、Prisma が内部で差分検証する段階で **想定外の状態** になると `P3006` (過去 migration が clean に適用できない) が発生します。

SharedNote 追加時、素直に `npx prisma migrate dev` をすると Shadow DB 上で手書き SQL が失敗し続ける構造でした。

---

## 3. 今回取った特殊手順 (Baseline 追加 + 手動テーブル作成)

> 目的: 既存 DB に実データがある状態で SharedNote を導入し、`migrate dev` の失敗を迂回する。

### 手順サマリ

1. 既存状態確認
   ```console
   npx prisma migrate status
   ```
2. Baseline 用ディレクトリ作成 (空)
   ```console
   mkdir -p prisma/migrations/20250818_baseline
   ```
3. “空 → 現在の schema” 差分 SQL を baseline に生成
   ```console
   npx prisma migrate diff \
     --from-empty \
     --to-schema-datamodel prisma/schema.prisma \
     --script > prisma/migrations/20250818_baseline/migration.sql
   ```
   - ここに SharedNote 含む全テーブル CREATE が入る。
4. Prisma に baseline を「適用済み」登録 (実 DB への再適用はしない)
   ```console
   npx prisma migrate resolve --applied 20250818_baseline
   ```
5. 状態再確認: baseline 含め 3 件扱いになる
   ```console
   npx prisma migrate status
   ```
6. しかし `migrate dev` 実行で再び `P3006` (shadow 上) → 既存 2 つの DO $$ に起因。
7. 回避策として SharedNote を **手動 SQL** で直接作成:
   - SQL ファイル作成 `prisma/manual_sharednote_create.sql`
   - 実行
     ```console
     npx prisma db execute --schema=prisma/schema.prisma --file=prisma/manual_sharednote_create.sql
     ```
8. 動作検証: Prisma Client で upsert テスト
   ```console
   node scripts/testSharedNote.js
   ```
9. API (`/api/shared-note`) からも GET/POST 確認すれば完了。

### 採った方針の意味

SharedNote 追加を **履歴 (migration chain)** ではなく baseline に内包させ「最初から存在したテーブル」と見なす構造にした。副作用として SharedNote 追加日が履歴として明示されないが、Shadow 失敗を避け現行データを保持可能。

---

## 4. P3006 の仕組みと再発防止

`P3006` は「過去 migration をクリーンに再適用できない」＝ Shadow 再構築で失敗。原因:

1. 手書き SQL が存在前提のオブジェクトを参照 (今回: Staff テーブル存在チェックで例外を投げる)
2. 外部依存 (権限 / 拡張) が Shadow で揃わない
3. Prisma が生成した migration 外の手作業変更 (ドリフト) を schema だけで再現できない

回避: 手書きロジックを最小化し、素直な CREATE/ALTER のみにする。条件付き ALTER が必要な場合でも **例外を投げずにスキップ** する形へ。

---

## 5. 今後の推奨リファクタ (任意)

| 案  | 内容                                                          | 利点                    | コスト                                                    |
| --- | ------------------------------------------------------------- | ----------------------- | --------------------------------------------------------- |
| A   | 既存 DO $$ 2 本を削除し schema と同義な新 baseline を作り直し | 以降 `migrate dev` 安定 | 本番再構築か export/import 作業                           |
| B   | 現状維持 + 以降は schema 変更時だけ通常フロー                 | 低コスト                | Shadow で毎回同じ P3006 可能性 (機能拡張時に都度手動対応) |

開発頻度が高くなるなら A へ移行推奨。

---

## 6. 新しいモデル追加チートシート

1. `schema.prisma` に model 追加
2. 通常は `npx prisma migrate dev --name add_xxx` (今回構造だと失敗する場合あり)
3. 失敗したら:
   - (暫定) diff で SQL 取得 → 手動 `db execute`
   - もしくは 5. の案 A に早期移行

---

## 7. トラブルシュート Quick Check

| 症状             | チェック                               | 対処                              |
| ---------------- | -------------------------------------- | --------------------------------- |
| P1001 接続不可   | `nc -vz host 5432`                     | VPC/Firewall / URL typo           |
| P3006            | 影響 migration 特定                    | 手書き SQL 精査 / baseline 再構築 |
| ドリフト警告     | `migrate status`                       | `prisma migrate diff` で差分検証  |
| テーブル足りない | `SELECT ... information_schema.tables` | `db execute` / migration 追加     |

---

## 8. 実行した主要コマンド一覧 (再現用)

```console
# 状態確認
npx prisma migrate status

# baseline ディレクトリ作成
mkdir -p prisma/migrations/20250818_baseline

# 空 → 現在スキーマ 差分 SQL 生成
npx prisma migrate diff \
  --from-empty \
  --to-schema-datamodel prisma/schema.prisma \
  --script > prisma/migrations/20250818_baseline/migration.sql

# baseline を適用済みマーク
npx prisma migrate resolve --applied 20250818_baseline

# (試行) 追加 migrate dev → P3006 発生
npx prisma migrate dev --name add_shared_note_table

# SharedNote 手動作成 SQL 実行
npx prisma db execute --schema=prisma/schema.prisma --file=prisma/manual_sharednote_create.sql

# 動作テスト (upsert)
node scripts/testSharedNote.js
```

---

## 9. 参考: 手動作成 SQL (抜粋)

```sql
CREATE TABLE IF NOT EXISTS "SharedNote" (
  "id" INTEGER PRIMARY KEY DEFAULT 1,
  "ops" TEXT NOT NULL DEFAULT '',
  "comm" TEXT NOT NULL DEFAULT '',
  "stoveDate" VARCHAR(32),
  "stoveNumber" VARCHAR(32),
  "opsFont" VARCHAR(64),
  "commFont" VARCHAR(64),
  "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

---

## 10. まとめ

今回: Shadow で壊れる手書き migration が存在 → baseline 追加 + 手動テーブル作成という迂回。学習ポイントは (a) baseline の概念, (b) P3006 の発生条件, (c) Prisma 外変更との付き合い方。今後は履歴の正規化 (案 A) を行えば日常運用がシンプルになります。

---

## 付録: よくある質問

Q. baseline 作った後にさらに別テーブル追加したいがまた P3006 が出る?  
A. 既存 DO $$ ロジックが残る限り起こり得る。早めに履歴を再構築 or DO $$ を素直な ALTER に書き換え。

Q. baseline に含まれるテーブルを削除したくなった?  
A. 通常の `migrate dev` で DROP を生成 (今回の特殊構成で失敗するなら一時的に手動 SQL)。

Q. 本番 DB を壊さず案 A へ移行するには?  
A. `pg_dump` → 新 DB に baseline 適用 → データ import → 以後新チェーン運用、など段階的移行。
